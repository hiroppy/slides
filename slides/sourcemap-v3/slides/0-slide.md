# Source Maps v3

---

Node@16 ã§ v3 ãŒå®‰å®šçš„ã¨ãªã‚Šã¾ã—ãŸ ğŸ‰

<br />

```shell
$ NODE_OPTIONS=--enable-source-maps node dist/index.js
```

<br />

Node.js ã¯ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ãŒ `//# sourceMappingURL=xxx.js.map` ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€<br />`require/import`ã§ã®ãƒ­ãƒ¼ãƒ‰æ™‚ã« sourcemap ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚

---

```ts
class MyError extends Error {
  constructor(message: string) {
    super(message);
    Error.captureStackTrace(this, MyError);
  }
}

throw new MyError('This line is L:8');
```

```shell
# ===== ğŸ˜­ =====
$ node dist/index.js
/dist/index.js:26 # 26ã¯ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®è¡Œ
throw new MyError('This line is L:8');
^

Error: This line is L:8
    at Object.<anonymous> (/dist/index.js:26:7)

# ===== ğŸ‘ =====
$ NODE_OPTIONS=--enable-source-maps node dist/index.js
/src/index.ts:8 # 8ã¯typescriptã§æ›¸ã‹ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®å®Ÿéš›ã®è¡Œ
throw new MyError('This line is L:8');
      ^

Error: This line is L:8
    at Object.<anonymous> (/src/index.ts:8:7)
```

---

`*.map` ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«

<br />

```json
{
  "version": 3,
  "file": "index.js",
  "sourceRoot": "",
  "sources": ["../src/index.ts"],
  "names": [],
  "mappings": ";;;;;;;;;;;;;;;;AAAA;IAAsB,2BAAK;IACzB,iBAAY,OAAe;QAA3B,YACE,kBAAM,OAAO,CAAC,SAEf;QADC,KAAK,CAAC,iBAAiB,CAAC,KAAI,EAAE,OAAO,CAAC,CAAC;;IACzC,CAAC;IACH,cAAC;AAAD,CAAC,AALD,CAAsB,KAAK,GAK1B;AAED,MAAM,IAAI,OAAO,CAAC,kBAAkB,CAAC,CAAC"
}
```

[spec](http://sourcemaps.info/spec.html)

---

## BASE64 VLQ CODEC

<br />

`mappings`ã¯ Base64 VLQ ã§åœ§ç¸®ã•ã‚Œã¦ã„ã¦ã€ã‚½ãƒ¼ã‚¹ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«å‰å¾Œã®ä½ç½®ã‚’ä¿å­˜ã—ã¦ã„ã‚‹ã€‚

```txt
16) [0,0,0,0]
17) [4,0,0,22], [27,0,0,5]
18) [4,0,1,-25], [17,0,0,12], [7,0,0,15]
19) [8,0,0,-27], [12,0,1,2], [18,0,0,6], [7,0,0,7], [1,0,0,1], [9,0,2,-15]
20) [8,0,-1,1], [5,0,0,5], [1,0,0,1], [17,0,0,17], [1,0,0,1], [5,0,0,4], [2,0,0,2], [7,0,0,7], [1,0,0,1], [1,0,0,1]
22) [4,0,1,-41], [1,0,0,1]
23) [4,0,1,-3], [14,0,0,1]
24) [0,0,0,-1], [1,0,0,1], [0,0,-5,-1], [1,0,0,22], [5,0,0,5], [3,0,5,-26]
25) [0,0,2,-1], [6,0,0,6], [4,0,0,4], [7,0,0,7], [1,0,0,1], [18,0,0,18], [1,0,0,1], [1,0,0,1]
```

<br />

èª­ã¿ã‚„ã™ã„ã‚ˆã†ã«å¤‰æ›ã—ãŸå½¢  
`([from_position](source_index)=>[to_position])`

```txt
([0,0](#0)=>[16,0])
([0,22](#0)=>[17,4]) | ([0,27](#0)=>[17,31])
([1,-25](#0)=>[18,4]) | ([1,-13](#0)=>[18,21]) | ([1,2](#0)=>[18,28])
([1,-27](#0)=>[19,8]) | ([2,-25](#0)=>[19,20]) | ([2,-19](#0)=>[19,38]) | ([2,-12](#0)=>[19,45]) | ([2,-11](#0)=>[19,46]) | ([4,-26](#0)=>[19,55])
([3,1](#0)=>[20,8]) | ([3,6](#0)=>[20,13]) | ([3,7](#0)=>[20,14]) | ([3,24](#0)=>[20,31]) | ([3,25](#0)=>[20,32]) | ([3,29](#0)=>[20,37]) | ([3,31](#0)=>[20,39]) | ([3,38](#0)=>[20,46]) | ([3,39](#0)=>[20,47]) | ([3,40](#0)=>[20,48])
([4,-41](#0)=>[22,4]) | ([4,-40](#0)=>[22,5])
([5,-3](#0)=>[23,4]) | ([5,-2](#0)=>[23,18])
([5,-1](#0)=>[24,0]) | ([5,0](#0)=>[24,1]) | ([0,-1](#0)=>[24,1]) | ([0,21](#0)=>[24,2]) | ([0,26](#0)=>[24,7]) | ([5,0](#0)=>[24,10])
([7,-1](#0)=>[25,0]) | ([7,5](#0)=>[25,6]) | ([7,9](#0)=>[25,10]) | ([7,16](#0)=>[25,17]) | ([7,17](#0)=>[25,18]) | ([7,35](#0)=>[25,36]) | ([7,36](#0)=>[25,37]) | ([7,37](#0)=>[25,38])
```

[base64vlq](https://www.murzwin.com/base64vlq.html)

---

```ts
// ç”Ÿæˆå…ƒã‚³ãƒ¼ãƒ‰
class MyError extends Error { // L: 1
```

```ts
// ç”Ÿæˆå…ƒã‚³ãƒ¼ãƒ‰ã®åˆ†å‰²ã•ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ç¾¤, sourcemapsã¯0ã‚¹ã‚¿ãƒ¼ãƒˆ
class MyError extends // ([0,0](#0)=>[16,0])
Error                 // ([0,22](#0)=>[17,4])
 {                    // ([0,27](#0)=>[17,31])
```

```js
// ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰
var MyError = /** @class */ (function (_super) { // L:17
    __extends(MyError, _super);                  // L:18
```

---

## ã¾ã¨ã‚

<br />

- ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã¯ã€`NODE_OPTIONS=--enable-source-maps`ã‚’ã¤ã‘ã‚‹ã¨<br />ãƒ‡ãƒãƒƒã‚°ãŒæ–­ç„¶æ¥½ã«ãªã‚‹
- sourcemaps ã®ä»•çµ„ã¿ã¯é¢ç™½ã„

---

# The End
